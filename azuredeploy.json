{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "virtualNetworkName":{
         "type":"string",
         "defaultValue":"vnet",
         "metadata":{
            "description":"VNet name"
         }
      },
      "vnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.0/24",
         "metadata":{
            "description":"The address space for the virtual network"
         }
      },
      "gwsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.80/28",
         "metadata":{
            "description":"The address space for gateway subnet network"
         }
      },
      "appGatewayPrefix":{
         "type":"string",
         "defaultValue":"app-gtw",
         "metadata":{
            "description":""
         }
      },
      "websnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.128/27",
         "metadata":{
            "description":"The address space for web subnet network"
         }
      },
      "webPrefix":{
         "type":"string",
         "defaultValue":"web",
         "metadata":{
            "description":""
         }
      },
      "analyticsPrefix":{
         "type":"string",
         "defaultValue":"analytics",
         "metadata":{
            "description":""
         }
      },
      "analyticsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.192/28",
         "metadata":{
            "description":"The address space for management subnet network"
         }
      },
      "bastionsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.0/28",
         "metadata":{
            "description":"The address space for web subnet network"
         }
      },
      "BastionPrefix":{
         "type":"string",
         "defaultValue":"bastion",
         "metadata":{
            "description":""
         }
      },
      "sftpsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.48/28",
         "metadata":{
            "description":"The address space for management subnet network"
         }
      },
      "sftpPrefix":{
         "type":"string",
         "defaultValue":"sftp-config",
         "metadata":{
            "description":""
         }
      },
      "dataintegrationsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.64/28",
         "metadata":{
            "description":"The address space for web subnet network"
         }
      },
      "dataIntegrationPrefix":{
         "type":"string",
         "defaultValue":"data-integration",
         "metadata":{
            "description":""
         }
      },
      "appsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.96/27",
         "metadata":{
            "description":"The address space for management subnet network"
         }
      },
      "appPrefix":{
         "type":"string",
         "defaultValue":"app",
         "metadata":{
            "description":""
         }
      },
      "dbsnetaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.160/27",
         "metadata":{
            "description":"The address space for web subnet network"
         }
      },
      "DBPrefix":{
         "type":"string",
         "defaultValue":"db",
         "metadata":{
            "description":""
         }
      },
      "iamconfigaddressPrefix":{
         "type":"string",
         "defaultValue":"10.199.254.32/28",
         "metadata":{
            "description":"The address space for web subnet network"
         }
      },
      "IamConfigPrefix":{
         "type":"string",
         "defaultValue":"iam-config",
         "metadata":{
            "description":""
         }
      },
      "natgatewayname":{
         "defaultValue":"AppNatGateway",
         "type":"String",
         "metadata":{
            "description":"Name of the NAT gateway"
         }
      },
      "ConnectBastionIpname":{
         "defaultValue":"myPublicIP",
         "type":"String",
         "metadata":{
            "description":"Name of the NAT gateway public IP"
         }
      },
      "ClientIpname":{
         "defaultValue":"myPublicIPVM",
         "type":"String",
         "metadata":{
            "description":"Name of the virtual machine public IP"
         }
      },
      "bastionName":{
         "defaultValue":"BastionService",
         "type":"String",
         "metadata":{
            "description":"Name of the Bastion Service"
         }
      },
      "publicIpAddressForBastion":{
         "type":"String",
         "defaultValue":"BastionServicePublicIP",
         "metadata":{
            "description":"IP Addresss of the Bastion Service"
         }
      },
      "applicationGatewayName":{
         "type":"string",
         "defaultValue":"App-gw"
      },
      "AppGatewayTier":{
         "type":"string",
         "defaultValue":"WAF"
      },
      "AppGatewaySkuSize":{
         "type":"string",
         "defaultValue":"WAF_Medium"
      },
      "publicIpAddressGateway":{
         "type":"string",
         "defaultValue":"AppGatewayPublicIP"
      },
      "AppGatewayCapacity":{
         "type":"int",
         "defaultValue":2
      },
        "storageAccountName":{
            "type": "string",
            "defaultValue":"scoreplussa"
        },
         "vmConfiguration":{
             "type": "array",
            "defaultValue":[
            {
            "vm_Name": "web",
            "virtualMachineSize":"Standard_D4s_v4",
            "adminUsername":"Admin1234",
            "adminPassword":"Admin@123445",
            "subnetName":"web-subnet",
            "networkInterfaceName":"web",
            "networkSecurityGroupName":"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', 'web-nsg')]",
            "osDiskType":"StandardSSD_LRS",
            "publisher":"MicrosoftWindowsServer",
            "offer":"WindowsServer",
            "sku":"2016-Datacenter",
            "version":"latest",
            "NumberOfDisk":2,
            "DataDisk1sku": "StandardSSD_LRS",
            "DataDisk1SizeGB": 128,
            "DataDisk2sku": "StandardSSD_LRS",
            "DataDisk2SizeGB": 256
            },
            {
            "vm_Name": "app",
            "virtualMachineSize":"Standard_D4s_v4",
            "adminUsername":"Admin1234",
            "adminPassword":"Admin@123445",
            "subnetName":"app-subnet",
            "networkInterfaceName":"app",
            "networkSecurityGroupName":"[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', 'web-nsg')]",
            "osDiskType":"StandardSSD_LRS",
            "diskSizeGB":"1023",
            "publisher":"MicrosoftWindowsServer",
            "offer":"WindowsServer",
            "sku":"2016-Datacenter",
            "version":"latest",
            "NumberOfDisk":2,
            "DataDisk1sku": "StandardSSD_LRS",
            "DataDisk1SizeGB": 128,
            "DataDisk2sku": "StandardSSD_LRS",
            "DataDisk2SizeGB": 256     
            }
            ]
        }
   },
   "variables":{
      "NetworkTemplatelink":"https://raw.githubusercontent.com/gAnEsH1058/Score-ARM-Template/master/network.json",
      "VMTemplatelink":"https://raw.githubusercontent.com/gAnEsH1058/Score-ARM-Template/master/vmserver.json"
   },
   "resources":[
      {
         "apiVersion":"2015-01-01",
         "name":"NetowrkTemplateDeployment",
         "type":"Microsoft.Resources/deployments",
         "properties":{
            "mode":"incremental",
            "templateLink":{
               "uri":"[variables('NetworkTemplatelink')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{
               "virtualNetworkName":{
                  "value":"[parameters('virtualNetworkName')]"
               },
               "vnetaddressPrefix":{
                  "value":"[parameters('vnetaddressPrefix')]"
               },
               "gwsnetaddressPrefix":{
                  "value":"[parameters('gwsnetaddressPrefix')]"
               },
               "appGatewayPrefix":{
                  "value":"[parameters('appGatewayPrefix')]"
               },
               "websnetaddressPrefix":{
                  "value":"[parameters('websnetaddressPrefix')]"
               },
               "webPrefix":{
                  "value":"[parameters('webPrefix')]"
               },
               "analyticsPrefix":{
                  "value":"[parameters('analyticsPrefix')]"
               },
               "analyticsnetaddressPrefix":{
                  "value":"[parameters('analyticsnetaddressPrefix')]"
               },
               "bastionsnetaddressPrefix":{
                  "value":"[parameters('bastionsnetaddressPrefix')]"
               },
               "BastionPrefix":{
                  "value":"[parameters('BastionPrefix')]"
               },
               "sftpsnetaddressPrefix":{
                  "value":"[parameters('sftpsnetaddressPrefix')]"
               },
               "sftpPrefix":{
                  "value":"[parameters('sftpPrefix')]"
               },
               "dataintegrationsnetaddressPrefix":{
                  "value":"[parameters('dataintegrationsnetaddressPrefix')]"
               },
               "dataIntegrationPrefix":{
                  "value":"[parameters('dataIntegrationPrefix')]"
               },
               "appsnetaddressPrefix":{
                  "value":"[parameters('appsnetaddressPrefix')]"
               },
               "appPrefix":{
                  "value":"[parameters('appPrefix')]"
               },
               "dbsnetaddressPrefix":{
                  "value":"[parameters('dbsnetaddressPrefix')]"
               },
               "DBPrefix":{
                  "value":"[parameters('DBPrefix')]"
               },
               "iamconfigaddressPrefix":{
                  "value":"[parameters('iamconfigaddressPrefix')]"
               },
               "IamConfigPrefix":{
                  "value":"[parameters('IamConfigPrefix')]"
               },
               "natgatewayname":{
                  "value":"[parameters('natgatewayname')]"
               },
               "ConnectBastionIpname":{
                  "value":"[parameters('ConnectBastionIpname')]"
               },
               "ClientIpname":{
                  "value":"[parameters('ClientIpname')]"
               },
               "bastionName":{
                  "value":"[parameters('bastionName')]"
               },
               "publicIpAddressForBastion":{
                  "value":"[parameters('publicIpAddressForBastion')]"
               },
               "applicationGatewayName":{
                  "value":"[parameters('applicationGatewayName')]"
               },
               "AppGatewayTier":{
                  "value":"[parameters('AppGatewayTier')]"
               },
               "AppGatewaySkuSize":{
                  "value":"[parameters('AppGatewaySkuSize')]"
               },
               "publicIpAddressGateway":{
                  "value":"[parameters('publicIpAddressGateway')]"
               },
               "AppGatewayCapacity":{
                  "value":"[parameters('AppGatewayCapacity')]"
               }
            }
         }
      },
      {
         "type":"Microsoft.Resources/deployments",
         "name":"updateIp",
         "apiVersion":"2020-06-01",
         "dependsOn":[
            "[variables('nicName')]"
         ],
         "properties":{
            "mode":"Incremental",
            "templateLink":{
               "uri":"[variables('updateip_templateUri')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{
               "nicName":{
                  "value":"[variables('nicName')]"
               },
               "SubnetRef":{
                  "value":"[variables('SubnetRef')]"
               },
               "privateIp":{
                  "value":"[reference(variables('nicName')).ipConfigurations[0].properties.privateIPAddress]"
               },
               "location":{
                  "value":"[parameters('location')]"
               }
            }
         }
      }
   ]
}